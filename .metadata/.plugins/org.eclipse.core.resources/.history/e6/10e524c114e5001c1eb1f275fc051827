#include "stm32f4xx.h"

// ------ SYSTICK
// CORTEX-M4 DEVICES GENERIC USER GUIDE
// https://developer.arm.com/documentation/dui0553/a/
// 4.4 system timer, SysTick.
// Table 4-33 SysTick SYST_CSR register bit assignments.

#define BIT_0                   (1U << 0)
#define BIT_2                   (1U << 2)
#define BIT_16					(1U << 16)

#define SYSTICK_LOAD_VAL		16000
#define CTRL_ENABLE				BIT_0         // Enable the counter.
#define CTRL_CLKSRC				BIT_2		  // Indicates the clock source.
#define CTRL_COUNTFLAG			BIT_16		  // 1 if timer count to 0 last

void systickDelayMs(int delay)
{
	// ------ Configure the SysTick.

	// Reload with number of clocks per millisecond.
	SysTick->LOAD = SYSTICK_LOAD_VAL;

	// Clear SysTick current value register.
	SysTick->VAL = 0;

	// Enable SysTick and select internal clock source.
	SysTick->CTRL = CTRL_ENABLE | CTRL_CLKSRC;

	for (int i = 0; i < delay; ++i)
	{
		// Wait before the count flag has been set.
		while ((SysTick->CTRL & CTRL_COUNTFLAG) == 0) {}
	}
	SysTick->CTRL = 0;
}
